{"payload":{"allShortcutsEnabled":false,"fileTree":{"src":{"items":[{"name":"img","path":"src/img","contentType":"directory"},{"name":"SUMMARY.md","path":"src/SUMMARY.md","contentType":"file"},{"name":"appendix-00.md","path":"src/appendix-00.md","contentType":"file"},{"name":"appendix-01-keywords.md","path":"src/appendix-01-keywords.md","contentType":"file"},{"name":"appendix-02-operators.md","path":"src/appendix-02-operators.md","contentType":"file"},{"name":"appendix-03-derivable-traits.md","path":"src/appendix-03-derivable-traits.md","contentType":"file"},{"name":"appendix-04-useful-development-tools.md","path":"src/appendix-04-useful-development-tools.md","contentType":"file"},{"name":"appendix-05-editions.md","path":"src/appendix-05-editions.md","contentType":"file"},{"name":"appendix-06-translation.md","path":"src/appendix-06-translation.md","contentType":"file"},{"name":"appendix-07-nightly-rust.md","path":"src/appendix-07-nightly-rust.md","contentType":"file"},{"name":"ch00-00-introduction.md","path":"src/ch00-00-introduction.md","contentType":"file"},{"name":"ch01-00-getting-started.md","path":"src/ch01-00-getting-started.md","contentType":"file"},{"name":"ch01-01-installation.md","path":"src/ch01-01-installation.md","contentType":"file"},{"name":"ch01-02-hello-world.md","path":"src/ch01-02-hello-world.md","contentType":"file"},{"name":"ch01-03-hello-cargo.md","path":"src/ch01-03-hello-cargo.md","contentType":"file"},{"name":"ch02-00-guessing-game-tutorial.md","path":"src/ch02-00-guessing-game-tutorial.md","contentType":"file"},{"name":"ch03-00-common-programming-concepts.md","path":"src/ch03-00-common-programming-concepts.md","contentType":"file"},{"name":"ch03-01-variables-and-mutability.md","path":"src/ch03-01-variables-and-mutability.md","contentType":"file"},{"name":"ch03-02-data-types.md","path":"src/ch03-02-data-types.md","contentType":"file"},{"name":"ch03-03-how-functions-work.md","path":"src/ch03-03-how-functions-work.md","contentType":"file"},{"name":"ch03-04-comments.md","path":"src/ch03-04-comments.md","contentType":"file"},{"name":"ch03-05-control-flow.md","path":"src/ch03-05-control-flow.md","contentType":"file"},{"name":"ch04-00-understanding-ownership.md","path":"src/ch04-00-understanding-ownership.md","contentType":"file"},{"name":"ch04-01-what-is-ownership.md","path":"src/ch04-01-what-is-ownership.md","contentType":"file"},{"name":"ch04-02-references-and-borrowing.md","path":"src/ch04-02-references-and-borrowing.md","contentType":"file"},{"name":"ch04-03-slices.md","path":"src/ch04-03-slices.md","contentType":"file"},{"name":"ch05-00-structs.md","path":"src/ch05-00-structs.md","contentType":"file"},{"name":"ch05-01-defining-structs.md","path":"src/ch05-01-defining-structs.md","contentType":"file"},{"name":"ch05-02-example-structs.md","path":"src/ch05-02-example-structs.md","contentType":"file"},{"name":"ch05-03-method-syntax.md","path":"src/ch05-03-method-syntax.md","contentType":"file"},{"name":"ch06-00-enums.md","path":"src/ch06-00-enums.md","contentType":"file"},{"name":"ch06-01-defining-an-enum.md","path":"src/ch06-01-defining-an-enum.md","contentType":"file"},{"name":"ch06-02-match.md","path":"src/ch06-02-match.md","contentType":"file"},{"name":"ch06-03-if-let.md","path":"src/ch06-03-if-let.md","contentType":"file"},{"name":"ch07-00-managing-growing-projects-with-packages-crates-and-modules.md","path":"src/ch07-00-managing-growing-projects-with-packages-crates-and-modules.md","contentType":"file"},{"name":"ch07-01-packages-and-crates.md","path":"src/ch07-01-packages-and-crates.md","contentType":"file"},{"name":"ch07-02-defining-modules-to-control-scope-and-privacy.md","path":"src/ch07-02-defining-modules-to-control-scope-and-privacy.md","contentType":"file"},{"name":"ch07-03-paths-for-referring-to-an-item-in-the-module-tree.md","path":"src/ch07-03-paths-for-referring-to-an-item-in-the-module-tree.md","contentType":"file"},{"name":"ch07-04-bringing-paths-into-scope-with-the-use-keyword.md","path":"src/ch07-04-bringing-paths-into-scope-with-the-use-keyword.md","contentType":"file"},{"name":"ch07-05-separating-modules-into-different-files.md","path":"src/ch07-05-separating-modules-into-different-files.md","contentType":"file"},{"name":"ch08-00-common-collections.md","path":"src/ch08-00-common-collections.md","contentType":"file"},{"name":"ch08-01-vectors.md","path":"src/ch08-01-vectors.md","contentType":"file"},{"name":"ch08-02-strings.md","path":"src/ch08-02-strings.md","contentType":"file"},{"name":"ch08-03-hash-maps.md","path":"src/ch08-03-hash-maps.md","contentType":"file"},{"name":"ch09-00-error-handling.md","path":"src/ch09-00-error-handling.md","contentType":"file"},{"name":"ch09-01-unrecoverable-errors-with-panic.md","path":"src/ch09-01-unrecoverable-errors-with-panic.md","contentType":"file"},{"name":"ch09-02-recoverable-errors-with-result.md","path":"src/ch09-02-recoverable-errors-with-result.md","contentType":"file"},{"name":"ch09-03-to-panic-or-not-to-panic.md","path":"src/ch09-03-to-panic-or-not-to-panic.md","contentType":"file"},{"name":"ch10-00-generics.md","path":"src/ch10-00-generics.md","contentType":"file"},{"name":"ch10-01-syntax.md","path":"src/ch10-01-syntax.md","contentType":"file"},{"name":"ch10-02-traits.md","path":"src/ch10-02-traits.md","contentType":"file"},{"name":"ch10-03-lifetime-syntax.md","path":"src/ch10-03-lifetime-syntax.md","contentType":"file"},{"name":"ch11-00-testing.md","path":"src/ch11-00-testing.md","contentType":"file"},{"name":"ch11-01-writing-tests.md","path":"src/ch11-01-writing-tests.md","contentType":"file"},{"name":"ch11-02-running-tests.md","path":"src/ch11-02-running-tests.md","contentType":"file"},{"name":"ch11-03-test-organization.md","path":"src/ch11-03-test-organization.md","contentType":"file"},{"name":"ch12-00-an-io-project.md","path":"src/ch12-00-an-io-project.md","contentType":"file"},{"name":"ch12-01-accepting-command-line-arguments.md","path":"src/ch12-01-accepting-command-line-arguments.md","contentType":"file"},{"name":"ch12-02-reading-a-file.md","path":"src/ch12-02-reading-a-file.md","contentType":"file"},{"name":"ch12-03-improving-error-handling-and-modularity.md","path":"src/ch12-03-improving-error-handling-and-modularity.md","contentType":"file"},{"name":"ch12-04-testing-the-librarys-functionality.md","path":"src/ch12-04-testing-the-librarys-functionality.md","contentType":"file"},{"name":"ch12-05-working-with-environment-variables.md","path":"src/ch12-05-working-with-environment-variables.md","contentType":"file"},{"name":"ch12-06-writing-to-stderr-instead-of-stdout.md","path":"src/ch12-06-writing-to-stderr-instead-of-stdout.md","contentType":"file"},{"name":"ch13-00-functional-features.md","path":"src/ch13-00-functional-features.md","contentType":"file"},{"name":"ch13-01-closures.md","path":"src/ch13-01-closures.md","contentType":"file"},{"name":"ch13-02-iterators.md","path":"src/ch13-02-iterators.md","contentType":"file"},{"name":"ch13-03-improving-our-io-project.md","path":"src/ch13-03-improving-our-io-project.md","contentType":"file"},{"name":"ch13-04-performance.md","path":"src/ch13-04-performance.md","contentType":"file"},{"name":"ch14-00-more-about-cargo.md","path":"src/ch14-00-more-about-cargo.md","contentType":"file"},{"name":"ch14-01-release-profiles.md","path":"src/ch14-01-release-profiles.md","contentType":"file"},{"name":"ch14-02-publishing-to-crates-io.md","path":"src/ch14-02-publishing-to-crates-io.md","contentType":"file"},{"name":"ch14-03-cargo-workspaces.md","path":"src/ch14-03-cargo-workspaces.md","contentType":"file"},{"name":"ch14-04-installing-binaries.md","path":"src/ch14-04-installing-binaries.md","contentType":"file"},{"name":"ch14-05-extending-cargo.md","path":"src/ch14-05-extending-cargo.md","contentType":"file"},{"name":"ch15-00-smart-pointers.md","path":"src/ch15-00-smart-pointers.md","contentType":"file"},{"name":"ch15-01-box.md","path":"src/ch15-01-box.md","contentType":"file"},{"name":"ch15-02-deref.md","path":"src/ch15-02-deref.md","contentType":"file"},{"name":"ch15-03-drop.md","path":"src/ch15-03-drop.md","contentType":"file"},{"name":"ch15-04-rc.md","path":"src/ch15-04-rc.md","contentType":"file"},{"name":"ch15-05-interior-mutability.md","path":"src/ch15-05-interior-mutability.md","contentType":"file"},{"name":"ch15-06-reference-cycles.md","path":"src/ch15-06-reference-cycles.md","contentType":"file"},{"name":"ch16-00-concurrency.md","path":"src/ch16-00-concurrency.md","contentType":"file"},{"name":"ch16-01-threads.md","path":"src/ch16-01-threads.md","contentType":"file"},{"name":"ch16-02-message-passing.md","path":"src/ch16-02-message-passing.md","contentType":"file"},{"name":"ch16-03-shared-state.md","path":"src/ch16-03-shared-state.md","contentType":"file"},{"name":"ch16-04-extensible-concurrency-sync-and-send.md","path":"src/ch16-04-extensible-concurrency-sync-and-send.md","contentType":"file"},{"name":"ch17-00-oop.md","path":"src/ch17-00-oop.md","contentType":"file"},{"name":"ch17-01-what-is-oo.md","path":"src/ch17-01-what-is-oo.md","contentType":"file"},{"name":"ch17-02-trait-objects.md","path":"src/ch17-02-trait-objects.md","contentType":"file"},{"name":"ch17-03-oo-design-patterns.md","path":"src/ch17-03-oo-design-patterns.md","contentType":"file"},{"name":"ch18-00-patterns.md","path":"src/ch18-00-patterns.md","contentType":"file"},{"name":"ch18-01-all-the-places-for-patterns.md","path":"src/ch18-01-all-the-places-for-patterns.md","contentType":"file"},{"name":"ch18-02-refutability.md","path":"src/ch18-02-refutability.md","contentType":"file"},{"name":"ch18-03-pattern-syntax.md","path":"src/ch18-03-pattern-syntax.md","contentType":"file"},{"name":"ch19-00-advanced-features.md","path":"src/ch19-00-advanced-features.md","contentType":"file"},{"name":"ch19-01-unsafe-rust.md","path":"src/ch19-01-unsafe-rust.md","contentType":"file"},{"name":"ch19-03-advanced-traits.md","path":"src/ch19-03-advanced-traits.md","contentType":"file"},{"name":"ch19-04-advanced-types.md","path":"src/ch19-04-advanced-types.md","contentType":"file"},{"name":"ch19-05-advanced-functions-and-closures.md","path":"src/ch19-05-advanced-functions-and-closures.md","contentType":"file"},{"name":"ch19-06-macros.md","path":"src/ch19-06-macros.md","contentType":"file"},{"name":"ch20-00-final-project-a-web-server.md","path":"src/ch20-00-final-project-a-web-server.md","contentType":"file"},{"name":"ch20-01-single-threaded.md","path":"src/ch20-01-single-threaded.md","contentType":"file"},{"name":"ch20-02-multithreaded.md","path":"src/ch20-02-multithreaded.md","contentType":"file"},{"name":"ch20-03-graceful-shutdown-and-cleanup.md","path":"src/ch20-03-graceful-shutdown-and-cleanup.md","contentType":"file"},{"name":"foreword.md","path":"src/foreword.md","contentType":"file"},{"name":"title-page.md","path":"src/title-page.md","contentType":"file"}],"totalCount":106},"":{"items":[{"name":".cargo","path":".cargo","contentType":"directory"},{"name":".github","path":".github","contentType":"directory"},{"name":"2018-edition","path":"2018-edition","contentType":"directory"},{"name":"ci","path":"ci","contentType":"directory"},{"name":"dot","path":"dot","contentType":"directory"},{"name":"first-edition","path":"first-edition","contentType":"directory"},{"name":"listings","path":"listings","contentType":"directory"},{"name":"nostarch","path":"nostarch","contentType":"directory"},{"name":"redirects","path":"redirects","contentType":"directory"},{"name":"second-edition","path":"second-edition","contentType":"directory"},{"name":"src","path":"src","contentType":"directory"},{"name":"theme","path":"theme","contentType":"directory"},{"name":"tools","path":"tools","contentType":"directory"},{"name":".gitattributes","path":".gitattributes","contentType":"file"},{"name":".gitignore","path":".gitignore","contentType":"file"},{"name":"ADMIN_TASKS.md","path":"ADMIN_TASKS.md","contentType":"file"},{"name":"CONTRIBUTING.md","path":"CONTRIBUTING.md","contentType":"file"},{"name":"COPYRIGHT","path":"COPYRIGHT","contentType":"file"},{"name":"Cargo.lock","path":"Cargo.lock","contentType":"file"},{"name":"Cargo.toml","path":"Cargo.toml","contentType":"file"},{"name":"LICENSE-APACHE","path":"LICENSE-APACHE","contentType":"file"},{"name":"LICENSE-MIT","path":"LICENSE-MIT","contentType":"file"},{"name":"README.md","path":"README.md","contentType":"file"},{"name":"TODO.md","path":"TODO.md","contentType":"file"},{"name":"book.toml","path":"book.toml","contentType":"file"},{"name":"ferris.css","path":"ferris.css","contentType":"file"},{"name":"ferris.js","path":"ferris.js","contentType":"file"},{"name":"rust-toolchain","path":"rust-toolchain","contentType":"file"},{"name":"rustfmt.toml","path":"rustfmt.toml","contentType":"file"},{"name":"style-guide.md","path":"style-guide.md","contentType":"file"}],"totalCount":30}},"fileTreeProcessingTime":17.963006,"foldersToFetch":[],"reducedMotionEnabled":null,"repo":{"id":47854924,"defaultBranch":"main","name":"book","ownerLogin":"rust-lang","currentUserCanPush":false,"isFork":false,"isEmpty":false,"createdAt":"2015-12-11T22:49:49.000Z","ownerAvatar":"https://avatars.githubusercontent.com/u/5430905?v=4","public":true,"private":false,"isOrgOwned":true},"symbolsExpanded":false,"treeExpanded":true,"refInfo":{"name":"main","listCacheKey":"v0:1688046669.0","canEdit":false,"refType":"branch","currentOid":"72187f5cd0beaaa9c6f584156bcd88f921871e83"},"path":"src/ch17-03-oo-design-patterns.md","currentUser":null,"blob":{"rawLines":null,"stylingDirectives":null,"csv":null,"csvError":null,"dependabotInfo":{"showConfigurationBanner":false,"configFilePath":null,"networkDependabotPath":"/rust-lang/book/network/updates","dismissConfigurationNoticePath":"/settings/dismiss-notice/dependabot_configuration_notice","configurationNoticeDismissed":null,"repoAlertsPath":"/rust-lang/book/security/dependabot","repoSecurityAndAnalysisPath":"/rust-lang/book/settings/security_analysis","repoOwnerIsOrg":true,"currentUserCanAdminRepo":false},"displayName":"ch17-03-oo-design-patterns.md","displayUrl":"https://github.com/rust-lang/book/blob/main/src/ch17-03-oo-design-patterns.md?raw=true","headerInfo":{"blobSize":"26 KB","deleteInfo":{"deleteTooltip":"You must be signed in to make or propose changes"},"editInfo":{"editTooltip":"You must be signed in to make or propose changes"},"ghDesktopPath":"https://desktop.github.com","gitLfsPath":null,"onBranch":true,"shortPath":"13503ef","siteNavLoginPath":"/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fbook%2Fblob%2Fmain%2Fsrc%2Fch17-03-oo-design-patterns.md","isCSV":false,"isRichtext":true,"toc":[{"level":2,"text":"Implementing an Object-Oriented Design Pattern","anchor":"implementing-an-object-oriented-design-pattern","htmlText":"Implementing an Object-Oriented Design Pattern"},{"level":3,"text":"Defining Post and Creating a New Instance in the Draft State","anchor":"defining-post-and-creating-a-new-instance-in-the-draft-state","htmlText":"Defining Post and Creating a New Instance in the Draft State"},{"level":3,"text":"Storing the Text of the Post Content","anchor":"storing-the-text-of-the-post-content","htmlText":"Storing the Text of the Post Content"},{"level":3,"text":"Ensuring the Content of a Draft Post Is Empty","anchor":"ensuring-the-content-of-a-draft-post-is-empty","htmlText":"Ensuring the Content of a Draft Post Is Empty"},{"level":3,"text":"Requesting a Review of the Post Changes Its State","anchor":"requesting-a-review-of-the-post-changes-its-state","htmlText":"Requesting a Review of the Post Changes Its State"},{"level":3,"text":"Adding approve to Change the Behavior of content","anchor":"adding-approve-to-change-the-behavior-of-content","htmlText":"Adding approve to Change the Behavior of content"},{"level":4,"text":"Why Not An Enum?","anchor":"why-not-an-enum","htmlText":"Why Not An Enum?"},{"level":3,"text":"Trade-offs of the State Pattern","anchor":"trade-offs-of-the-state-pattern","htmlText":"Trade-offs of the State Pattern"},{"level":4,"text":"Encoding States and Behavior as Types","anchor":"encoding-states-and-behavior-as-types","htmlText":"Encoding States and Behavior as Types"},{"level":4,"text":"Implementing Transitions as Transformations into Different Types","anchor":"implementing-transitions-as-transformations-into-different-types","htmlText":"Implementing Transitions as Transformations into Different Types"},{"level":2,"text":"Summary","anchor":"summary","htmlText":"Summary"}],"lineInfo":{"truncatedLoc":"516","truncatedSloc":"408"},"mode":"file"},"image":false,"isCodeownersFile":null,"isPlain":false,"isValidLegacyIssueTemplate":false,"issueTemplateHelpUrl":"https://docs.github.com/articles/about-issue-and-pull-request-templates","issueTemplate":null,"discussionTemplate":null,"language":"Markdown","languageID":222,"large":false,"loggedIn":false,"newDiscussionPath":"/rust-lang/book/discussions/new","newIssuePath":"/rust-lang/book/issues/new","planSupportInfo":{"repoIsFork":null,"repoOwnedByCurrentUser":null,"requestFullPath":"/rust-lang/book/blob/main/src/ch17-03-oo-design-patterns.md","showFreeOrgGatedFeatureMessage":null,"showPlanSupportBanner":null,"upgradeDataAttributes":null,"upgradePath":null},"publishBannersInfo":{"dismissActionNoticePath":"/settings/dismiss-notice/publish_action_from_dockerfile","dismissStackNoticePath":"/settings/dismiss-notice/publish_stack_from_file","releasePath":"/rust-lang/book/releases/new?marketplace=true","showPublishActionBanner":false,"showPublishStackBanner":false},"renderImageOrRaw":false,"richText":"<article class=\"markdown-body entry-content container-lg\" itemprop=\"text\"><h2 tabindex=\"-1\" id=\"user-content-implementing-an-object-oriented-design-pattern\" dir=\"auto\"><a class=\"heading-link\" href=\"#implementing-an-object-oriented-design-pattern\">Implementing an Object-Oriented Design Pattern<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h2>\n<p dir=\"auto\">The <em>state pattern</em> is an object-oriented design pattern. The crux of the\npattern is that we define a set of states a value can have internally. The\nstates are represented by a set of <em>state objects</em>, and the value’s behavior\nchanges based on its state. We’re going to work through an example of a blog\npost struct that has a field to hold its state, which will be a state object\nfrom the set \"draft\", \"review\", or \"published\".</p>\n<p dir=\"auto\">The state objects share functionality: in Rust, of course, we use structs and\ntraits rather than objects and inheritance. Each state object is responsible\nfor its own behavior and for governing when it should change into another\nstate. The value that holds a state object knows nothing about the different\nbehavior of the states or when to transition between states.</p>\n<p dir=\"auto\">The advantage of using the state pattern is that, when the business\nrequirements of the program change, we won’t need to change the code of the\nvalue holding the state or the code that uses the value. We’ll only need to\nupdate the code inside one of the state objects to change its rules or perhaps\nadd more state objects.</p>\n<p dir=\"auto\">First, we’re going to implement the state pattern in a more traditional\nobject-oriented way, then we’ll use an approach that’s a bit more natural in\nRust. Let’s dig in to incrementally implementing a blog post workflow using the\nstate pattern.</p>\n<p dir=\"auto\">The final functionality will look like this:</p>\n<ol dir=\"auto\">\n<li>A blog post starts as an empty draft.</li>\n<li>When the draft is done, a review of the post is requested.</li>\n<li>When the post is approved, it gets published.</li>\n<li>Only published blog posts return content to print, so unapproved posts can’t\naccidentally be published.</li>\n</ol>\n<p dir=\"auto\">Any other changes attempted on a post should have no effect. For example, if we\ntry to approve a draft blog post before we’ve requested a review, the post\nshould remain an unpublished draft.</p>\n<p dir=\"auto\">Listing 17-11 shows this workflow in code form: this is an example usage of the\nAPI we’ll implement in a library crate named <code>blog</code>. This won’t compile yet\nbecause we haven’t implemented the <code>blog</code> crate.</p>\n<p dir=\"auto\"><span>Filename: src/main.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-11/src/main.rs:all}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">11</span>/src/main<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>all<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-11: Code that demonstrates the desired\nbehavior we want our <code>blog</code> crate to have</span></p>\n<p dir=\"auto\">We want to allow the user to create a new draft blog post with <code>Post::new</code>. We\nwant to allow text to be added to the blog post. If we try to get the post’s\ncontent immediately, before approval, we shouldn’t get any text because the\npost is still a draft. We’ve added <code>assert_eq!</code> in the code for demonstration\npurposes. An excellent unit test for this would be to assert that a draft blog\npost returns an empty string from the <code>content</code> method, but we’re not going to\nwrite tests for this example.</p>\n<p dir=\"auto\">Next, we want to enable a request for a review of the post, and we want\n<code>content</code> to return an empty string while waiting for the review. When the post\nreceives approval, it should get published, meaning the text of the post will\nbe returned when <code>content</code> is called.</p>\n<p dir=\"auto\">Notice that the only type we’re interacting with from the crate is the <code>Post</code>\ntype. This type will use the state pattern and will hold a value that will be\none of three state objects representing the various states a post can be\nin—draft, waiting for review, or published. Changing from one state to another\nwill be managed internally within the <code>Post</code> type. The states change in\nresponse to the methods called by our library’s users on the <code>Post</code> instance,\nbut they don’t have to manage the state changes directly. Also, users can’t\nmake a mistake with the states, like publishing a post before it’s reviewed.</p>\n<h3 tabindex=\"-1\" id=\"user-content-defining-post-and-creating-a-new-instance-in-the-draft-state\" dir=\"auto\"><a class=\"heading-link\" href=\"#defining-post-and-creating-a-new-instance-in-the-draft-state\">Defining <code>Post</code> and Creating a New Instance in the Draft State<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">Let’s get started on the implementation of the library! We know we need a\npublic <code>Post</code> struct that holds some content, so we’ll start with the\ndefinition of the struct and an associated public <code>new</code> function to create an\ninstance of <code>Post</code>, as shown in Listing 17-12. We’ll also make a private\n<code>State</code> trait that will define the behavior that all state objects for a <code>Post</code>\nmust have.</p>\n<p dir=\"auto\">Then <code>Post</code> will hold a trait object of <code>Box&lt;dyn State&gt;</code> inside an <code>Option&lt;T&gt;</code>\nin a private field named <code>state</code> to hold the state object. You’ll see why the\n<code>Option&lt;T&gt;</code> is necessary in a bit.</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-12/src/lib.rs}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">12</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-12: Definition of a <code>Post</code> struct and a <code>new</code>\nfunction that creates a new <code>Post</code> instance, a <code>State</code> trait, and a <code>Draft</code>\nstruct</span></p>\n<p dir=\"auto\">The <code>State</code> trait defines the behavior shared by different post states. The\nstate objects are <code>Draft</code>, <code>PendingReview</code>, and <code>Published</code>, and they will all\nimplement the <code>State</code> trait. For now, the trait doesn’t have any methods, and\nwe’ll start by defining just the <code>Draft</code> state because that is the state we\nwant a post to start in.</p>\n<p dir=\"auto\">When we create a new <code>Post</code>, we set its <code>state</code> field to a <code>Some</code> value that\nholds a <code>Box</code>. This <code>Box</code> points to a new instance of the <code>Draft</code> struct.\nThis ensures whenever we create a new instance of <code>Post</code>, it will start out as\na draft. Because the <code>state</code> field of <code>Post</code> is private, there is no way to\ncreate a <code>Post</code> in any other state! In the <code>Post::new</code> function, we set the\n<code>content</code> field to a new, empty <code>String</code>.</p>\n<h3 tabindex=\"-1\" id=\"user-content-storing-the-text-of-the-post-content\" dir=\"auto\"><a class=\"heading-link\" href=\"#storing-the-text-of-the-post-content\">Storing the Text of the Post Content<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">We saw in Listing 17-11 that we want to be able to call a method named\n<code>add_text</code> and pass it a <code>&amp;str</code> that is then added as the text content of the\nblog post. We implement this as a method, rather than exposing the <code>content</code>\nfield as <code>pub</code>, so that later we can implement a method that will control how\nthe <code>content</code> field’s data is read. The <code>add_text</code> method is pretty\nstraightforward, so let’s add the implementation in Listing 17-13 to the <code>impl Post</code> block:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-13/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">13</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-13: Implementing the <code>add_text</code> method to add\ntext to a post’s <code>content</code></span></p>\n<p dir=\"auto\">The <code>add_text</code> method takes a mutable reference to <code>self</code>, because we’re\nchanging the <code>Post</code> instance that we’re calling <code>add_text</code> on. We then call\n<code>push_str</code> on the <code>String</code> in <code>content</code> and pass the <code>text</code> argument to add to\nthe saved <code>content</code>. This behavior doesn’t depend on the state the post is in,\nso it’s not part of the state pattern. The <code>add_text</code> method doesn’t interact\nwith the <code>state</code> field at all, but it is part of the behavior we want to\nsupport.</p>\n<h3 tabindex=\"-1\" id=\"user-content-ensuring-the-content-of-a-draft-post-is-empty\" dir=\"auto\"><a class=\"heading-link\" href=\"#ensuring-the-content-of-a-draft-post-is-empty\">Ensuring the Content of a Draft Post Is Empty<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">Even after we’ve called <code>add_text</code> and added some content to our post, we still\nwant the <code>content</code> method to return an empty string slice because the post is\nstill in the draft state, as shown on line 7 of Listing 17-11. For now, let’s\nimplement the <code>content</code> method with the simplest thing that will fulfill this\nrequirement: always returning an empty string slice. We’ll change this later\nonce we implement the ability to change a post’s state so it can be published.\nSo far, posts can only be in the draft state, so the post content should always\nbe empty. Listing 17-14 shows this placeholder implementation:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-14/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">14</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-14: Adding a placeholder implementation for\nthe <code>content</code> method on <code>Post</code> that always returns an empty string slice</span></p>\n<p dir=\"auto\">With this added <code>content</code> method, everything in Listing 17-11 up to line 7\nworks as intended.</p>\n<h3 tabindex=\"-1\" id=\"user-content-requesting-a-review-of-the-post-changes-its-state\" dir=\"auto\"><a class=\"heading-link\" href=\"#requesting-a-review-of-the-post-changes-its-state\">Requesting a Review of the Post Changes Its State<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">Next, we need to add functionality to request a review of a post, which should\nchange its state from <code>Draft</code> to <code>PendingReview</code>. Listing 17-15 shows this code:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-15/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">15</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-15: Implementing <code>request_review</code> methods on\n<code>Post</code> and the <code>State</code> trait</span></p>\n<p dir=\"auto\">We give <code>Post</code> a public method named <code>request_review</code> that will take a mutable\nreference to <code>self</code>. Then we call an internal <code>request_review</code> method on the\ncurrent state of <code>Post</code>, and this second <code>request_review</code> method consumes the\ncurrent state and returns a new state.</p>\n<p dir=\"auto\">We add the <code>request_review</code> method to the <code>State</code> trait; all types that\nimplement the trait will now need to implement the <code>request_review</code> method.\nNote that rather than having <code>self</code>, <code>&amp;self</code>, or <code>&amp;mut self</code> as the first\nparameter of the method, we have <code>self: Box&lt;Self&gt;</code>. This syntax means the\nmethod is only valid when called on a <code>Box</code> holding the type. This syntax takes\nownership of <code>Box&lt;Self&gt;</code>, invalidating the old state so the state value of the\n<code>Post</code> can transform into a new state.</p>\n<p dir=\"auto\">To consume the old state, the <code>request_review</code> method needs to take ownership\nof the state value. This is where the <code>Option</code> in the <code>state</code> field of <code>Post</code>\ncomes in: we call the <code>take</code> method to take the <code>Some</code> value out of the <code>state</code>\nfield and leave a <code>None</code> in its place, because Rust doesn’t let us have\nunpopulated fields in structs. This lets us move the <code>state</code> value out of\n<code>Post</code> rather than borrowing it. Then we’ll set the post’s <code>state</code> value to the\nresult of this operation.</p>\n<p dir=\"auto\">We need to set <code>state</code> to <code>None</code> temporarily rather than setting it directly\nwith code like <code>self.state = self.state.request_review();</code> to get ownership of\nthe <code>state</code> value. This ensures <code>Post</code> can’t use the old <code>state</code> value after\nwe’ve transformed it into a new state.</p>\n<p dir=\"auto\">The <code>request_review</code> method on <code>Draft</code> returns a new, boxed instance of a new\n<code>PendingReview</code> struct, which represents the state when a post is waiting for a\nreview. The <code>PendingReview</code> struct also implements the <code>request_review</code> method\nbut doesn’t do any transformations. Rather, it returns itself, because when we\nrequest a review on a post already in the <code>PendingReview</code> state, it should stay\nin the <code>PendingReview</code> state.</p>\n<p dir=\"auto\">Now we can start seeing the advantages of the state pattern: the\n<code>request_review</code> method on <code>Post</code> is the same no matter its <code>state</code> value. Each\nstate is responsible for its own rules.</p>\n<p dir=\"auto\">We’ll leave the <code>content</code> method on <code>Post</code> as is, returning an empty string\nslice. We can now have a <code>Post</code> in the <code>PendingReview</code> state as well as in the\n<code>Draft</code> state, but we want the same behavior in the <code>PendingReview</code> state.\nListing 17-11 now works up to line 10!</p>\n\n<p dir=\"auto\"><a id=\"user-content-adding-the-approve-method-that-changes-the-behavior-of-content\"></a></p>\n<h3 tabindex=\"-1\" id=\"user-content-adding-approve-to-change-the-behavior-of-content\" dir=\"auto\"><a class=\"heading-link\" href=\"#adding-approve-to-change-the-behavior-of-content\">Adding <code>approve</code> to Change the Behavior of <code>content</code><svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">The <code>approve</code> method will be similar to the <code>request_review</code> method: it will\nset <code>state</code> to the value that the current state says it should have when that\nstate is approved, as shown in Listing 17-16:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-16/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">16</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-16: Implementing the <code>approve</code> method on\n<code>Post</code> and the <code>State</code> trait</span></p>\n<p dir=\"auto\">We add the <code>approve</code> method to the <code>State</code> trait and add a new struct that\nimplements <code>State</code>, the <code>Published</code> state.</p>\n<p dir=\"auto\">Similar to the way <code>request_review</code> on <code>PendingReview</code> works, if we call the\n<code>approve</code> method on a <code>Draft</code>, it will have no effect because <code>approve</code> will\nreturn <code>self</code>. When we call <code>approve</code> on <code>PendingReview</code>, it returns a new,\nboxed instance of the <code>Published</code> struct. The <code>Published</code> struct implements the\n<code>State</code> trait, and for both the <code>request_review</code> method and the <code>approve</code>\nmethod, it returns itself, because the post should stay in the <code>Published</code>\nstate in those cases.</p>\n<p dir=\"auto\">Now we need to update the <code>content</code> method on <code>Post</code>. We want the value\nreturned from <code>content</code> to depend on the current state of the <code>Post</code>, so we’re\ngoing to have the <code>Post</code> delegate to a <code>content</code> method defined on its <code>state</code>,\nas shown in Listing 17-17:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-17/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">17</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-17: Updating the <code>content</code> method on <code>Post</code> to\ndelegate to a <code>content</code> method on <code>State</code></span></p>\n<p dir=\"auto\">Because the goal is to keep all these rules inside the structs that implement\n<code>State</code>, we call a <code>content</code> method on the value in <code>state</code> and pass the post\ninstance (that is, <code>self</code>) as an argument. Then we return the value that’s\nreturned from using the <code>content</code> method on the <code>state</code> value.</p>\n<p dir=\"auto\">We call the <code>as_ref</code> method on the <code>Option</code> because we want a reference to the\nvalue inside the <code>Option</code> rather than ownership of the value. Because <code>state</code>\nis an <code>Option&lt;Box&lt;dyn State&gt;&gt;</code>, when we call <code>as_ref</code>, an <code>Option&lt;&amp;Box&lt;dyn State&gt;&gt;</code> is returned. If we didn’t call <code>as_ref</code>, we would get an error because\nwe can’t move <code>state</code> out of the borrowed <code>&amp;self</code> of the function parameter.</p>\n<p dir=\"auto\">We then call the <code>unwrap</code> method, which we know will never panic, because we\nknow the methods on <code>Post</code> ensure that <code>state</code> will always contain a <code>Some</code>\nvalue when those methods are done. This is one of the cases we talked about in\nthe <a href=\"/rust-lang/book/blob/main/src/ch09-03-to-panic-or-not-to-panic.html#cases-in-which-you-have-more-information-than-the-compiler\">“Cases In Which You Have More Information Than the\nCompiler”</a> section of Chapter 9 when we\nknow that a <code>None</code> value is never possible, even though the compiler isn’t able\nto understand that.</p>\n<p dir=\"auto\">At this point, when we call <code>content</code> on the <code>&amp;Box&lt;dyn State&gt;</code>, deref coercion\nwill take effect on the <code>&amp;</code> and the <code>Box</code> so the <code>content</code> method will\nultimately be called on the type that implements the <code>State</code> trait. That means\nwe need to add <code>content</code> to the <code>State</code> trait definition, and that is where\nwe’ll put the logic for what content to return depending on which state we\nhave, as shown in Listing 17-18:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-18/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">18</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-18: Adding the <code>content</code> method to the <code>State</code>\ntrait</span></p>\n<p dir=\"auto\">We add a default implementation for the <code>content</code> method that returns an empty\nstring slice. That means we don’t need to implement <code>content</code> on the <code>Draft</code>\nand <code>PendingReview</code> structs. The <code>Published</code> struct will override the <code>content</code>\nmethod and return the value in <code>post.content</code>.</p>\n<p dir=\"auto\">Note that we need lifetime annotations on this method, as we discussed in\nChapter 10. We’re taking a reference to a <code>post</code> as an argument and returning a\nreference to part of that <code>post</code>, so the lifetime of the returned reference is\nrelated to the lifetime of the <code>post</code> argument.</p>\n<p dir=\"auto\">And we’re done—all of Listing 17-11 now works! We’ve implemented the state\npattern with the rules of the blog post workflow. The logic related to the\nrules lives in the state objects rather than being scattered throughout <code>Post</code>.</p>\n<blockquote>\n<h4 tabindex=\"-1\" id=\"user-content-why-not-an-enum\" dir=\"auto\"><a class=\"heading-link\" href=\"#why-not-an-enum\">Why Not An Enum?<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h4>\n<p dir=\"auto\">You may have been wondering why we didn’t use an <code>enum</code> with the different\npossible post states as variants. That’s certainly a possible solution, try\nit and compare the end results to see which you prefer! One disadvantage of\nusing an enum is every place that checks the value of the enum will need a\n<code>match</code> expression or similar to handle every possible variant. This could\nget more repetitive than this trait object solution.</p>\n</blockquote>\n<h3 tabindex=\"-1\" id=\"user-content-trade-offs-of-the-state-pattern\" dir=\"auto\"><a class=\"heading-link\" href=\"#trade-offs-of-the-state-pattern\">Trade-offs of the State Pattern<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h3>\n<p dir=\"auto\">We’ve shown that Rust is capable of implementing the object-oriented state\npattern to encapsulate the different kinds of behavior a post should have in\neach state. The methods on <code>Post</code> know nothing about the various behaviors. The\nway we organized the code, we have to look in only one place to know the\ndifferent ways a published post can behave: the implementation of the <code>State</code>\ntrait on the <code>Published</code> struct.</p>\n<p dir=\"auto\">If we were to create an alternative implementation that didn’t use the state\npattern, we might instead use <code>match</code> expressions in the methods on <code>Post</code> or\neven in the <code>main</code> code that checks the state of the post and changes behavior\nin those places. That would mean we would have to look in several places to\nunderstand all the implications of a post being in the published state! This\nwould only increase the more states we added: each of those <code>match</code> expressions\nwould need another arm.</p>\n<p dir=\"auto\">With the state pattern, the <code>Post</code> methods and the places we use <code>Post</code> don’t\nneed <code>match</code> expressions, and to add a new state, we would only need to add a\nnew struct and implement the trait methods on that one struct.</p>\n<p dir=\"auto\">The implementation using the state pattern is easy to extend to add more\nfunctionality. To see the simplicity of maintaining code that uses the state\npattern, try a few of these suggestions:</p>\n<ul dir=\"auto\">\n<li>Add a <code>reject</code> method that changes the post’s state from <code>PendingReview</code> back\nto <code>Draft</code>.</li>\n<li>Require two calls to <code>approve</code> before the state can be changed to <code>Published</code>.</li>\n<li>Allow users to add text content only when a post is in the <code>Draft</code> state.\nHint: have the state object responsible for what might change about the\ncontent but not responsible for modifying the <code>Post</code>.</li>\n</ul>\n<p dir=\"auto\">One downside of the state pattern is that, because the states implement the\ntransitions between states, some of the states are coupled to each other. If we\nadd another state between <code>PendingReview</code> and <code>Published</code>, such as <code>Scheduled</code>,\nwe would have to change the code in <code>PendingReview</code> to transition to\n<code>Scheduled</code> instead. It would be less work if <code>PendingReview</code> didn’t need to\nchange with the addition of a new state, but that would mean switching to\nanother design pattern.</p>\n<p dir=\"auto\">Another downside is that we’ve duplicated some logic. To eliminate some of the\nduplication, we might try to make default implementations for the\n<code>request_review</code> and <code>approve</code> methods on the <code>State</code> trait that return <code>self</code>;\nhowever, this would violate object safety, because the trait doesn’t know what\nthe concrete <code>self</code> will be exactly. We want to be able to use <code>State</code> as a\ntrait object, so we need its methods to be object safe.</p>\n<p dir=\"auto\">Other duplication includes the similar implementations of the <code>request_review</code>\nand <code>approve</code> methods on <code>Post</code>. Both methods delegate to the implementation of\nthe same method on the value in the <code>state</code> field of <code>Option</code> and set the new\nvalue of the <code>state</code> field to the result. If we had a lot of methods on <code>Post</code>\nthat followed this pattern, we might consider defining a macro to eliminate the\nrepetition (see the <a href=\"/rust-lang/book/blob/main/src/ch19-06-macros.html#macros\">“Macros”</a> section in Chapter 19).</p>\n<p dir=\"auto\">By implementing the state pattern exactly as it’s defined for object-oriented\nlanguages, we’re not taking as full advantage of Rust’s strengths as we could.\nLet’s look at some changes we can make to the <code>blog</code> crate that can make\ninvalid states and transitions into compile time errors.</p>\n<h4 tabindex=\"-1\" id=\"user-content-encoding-states-and-behavior-as-types\" dir=\"auto\"><a class=\"heading-link\" href=\"#encoding-states-and-behavior-as-types\">Encoding States and Behavior as Types<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h4>\n<p dir=\"auto\">We’ll show you how to rethink the state pattern to get a different set of\ntrade-offs. Rather than encapsulating the states and transitions completely so\noutside code has no knowledge of them, we’ll encode the states into different\ntypes. Consequently, Rust’s type checking system will prevent attempts to use\ndraft posts where only published posts are allowed by issuing a compiler error.</p>\n<p dir=\"auto\">Let’s consider the first part of <code>main</code> in Listing 17-11:</p>\n<p dir=\"auto\"><span>Filename: src/main.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-11/src/main.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">11</span>/src/main<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\">We still enable the creation of new posts in the draft state using <code>Post::new</code>\nand the ability to add text to the post’s content. But instead of having a\n<code>content</code> method on a draft post that returns an empty string, we’ll make it so\ndraft posts don’t have the <code>content</code> method at all. That way, if we try to get\na draft post’s content, we’ll get a compiler error telling us the method\ndoesn’t exist. As a result, it will be impossible for us to accidentally\ndisplay draft post content in production, because that code won’t even compile.\nListing 17-19 shows the definition of a <code>Post</code> struct and a <code>DraftPost</code> struct,\nas well as methods on each:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-19/src/lib.rs}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">19</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-19: A <code>Post</code> with a <code>content</code> method and a\n<code>DraftPost</code> without a <code>content</code> method</span></p>\n<p dir=\"auto\">Both the <code>Post</code> and <code>DraftPost</code> structs have a private <code>content</code> field that\nstores the blog post text. The structs no longer have the <code>state</code> field because\nwe’re moving the encoding of the state to the types of the structs. The <code>Post</code>\nstruct will represent a published post, and it has a <code>content</code> method that\nreturns the <code>content</code>.</p>\n<p dir=\"auto\">We still have a <code>Post::new</code> function, but instead of returning an instance of\n<code>Post</code>, it returns an instance of <code>DraftPost</code>. Because <code>content</code> is private\nand there aren’t any functions that return <code>Post</code>, it’s not possible to create\nan instance of <code>Post</code> right now.</p>\n<p dir=\"auto\">The <code>DraftPost</code> struct has an <code>add_text</code> method, so we can add text to\n<code>content</code> as before, but note that <code>DraftPost</code> does not have a <code>content</code> method\ndefined! So now the program ensures all posts start as draft posts, and draft\nposts don’t have their content available for display. Any attempt to get around\nthese constraints will result in a compiler error.</p>\n<h4 tabindex=\"-1\" id=\"user-content-implementing-transitions-as-transformations-into-different-types\" dir=\"auto\"><a class=\"heading-link\" href=\"#implementing-transitions-as-transformations-into-different-types\">Implementing Transitions as Transformations into Different Types<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h4>\n<p dir=\"auto\">So how do we get a published post? We want to enforce the rule that a draft\npost has to be reviewed and approved before it can be published. A post in the\npending review state should still not display any content. Let’s implement\nthese constraints by adding another struct, <code>PendingReviewPost</code>, defining the\n<code>request_review</code> method on <code>DraftPost</code> to return a <code>PendingReviewPost</code>, and\ndefining an <code>approve</code> method on <code>PendingReviewPost</code> to return a <code>Post</code>, as\nshown in Listing 17-20:</p>\n<p dir=\"auto\"><span>Filename: src/lib.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-20/src/lib.rs:here}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">20</span>/src/lib<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">:</span>here<span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-20: A <code>PendingReviewPost</code> that gets created by\ncalling <code>request_review</code> on <code>DraftPost</code> and an <code>approve</code> method that turns a\n<code>PendingReviewPost</code> into a published <code>Post</code></span></p>\n<p dir=\"auto\">The <code>request_review</code> and <code>approve</code> methods take ownership of <code>self</code>, thus\nconsuming the <code>DraftPost</code> and <code>PendingReviewPost</code> instances and transforming\nthem into a <code>PendingReviewPost</code> and a published <code>Post</code>, respectively. This way,\nwe won’t have any lingering <code>DraftPost</code> instances after we’ve called\n<code>request_review</code> on them, and so forth. The <code>PendingReviewPost</code> struct doesn’t\nhave a <code>content</code> method defined on it, so attempting to read its content\nresults in a compiler error, as with <code>DraftPost</code>. Because the only way to get a\npublished <code>Post</code> instance that does have a <code>content</code> method defined is to call\nthe <code>approve</code> method on a <code>PendingReviewPost</code>, and the only way to get a\n<code>PendingReviewPost</code> is to call the <code>request_review</code> method on a <code>DraftPost</code>,\nwe’ve now encoded the blog post workflow into the type system.</p>\n<p dir=\"auto\">But we also have to make some small changes to <code>main</code>. The <code>request_review</code> and\n<code>approve</code> methods return new instances rather than modifying the struct they’re\ncalled on, so we need to add more <code>let post =</code> shadowing assignments to save\nthe returned instances. We also can’t have the assertions about the draft and\npending review posts’ contents be empty strings, nor do we need them: we can’t\ncompile code that tries to use the content of posts in those states any longer.\nThe updated code in <code>main</code> is shown in Listing 17-21:</p>\n<p dir=\"auto\"><span>Filename: src/main.rs</span></p>\n<div class=\"highlight highlight-source-rust notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"{{#rustdoc_include ../listings/ch17-oop/listing-17-21/src/main.rs}}\"><pre><span class=\"pl-kos\">{</span><span class=\"pl-kos\">{</span>#rustdoc_include ../listings/ch17-oop/listing-<span class=\"pl-c1\">17</span>-<span class=\"pl-c1\">21</span>/src/main<span class=\"pl-kos\">.</span><span class=\"pl-c1\">rs</span><span class=\"pl-kos\">}</span><span class=\"pl-kos\">}</span></pre></div>\n<p dir=\"auto\"><span>Listing 17-21: Modifications to <code>main</code> to use the new\nimplementation of the blog post workflow</span></p>\n<p dir=\"auto\">The changes we needed to make to <code>main</code> to reassign <code>post</code> mean that this\nimplementation doesn’t quite follow the object-oriented state pattern anymore:\nthe transformations between the states are no longer encapsulated entirely\nwithin the <code>Post</code> implementation. However, our gain is that invalid states are\nnow impossible because of the type system and the type checking that happens at\ncompile time! This ensures that certain bugs, such as display of the content of\nan unpublished post, will be discovered before they make it to production.</p>\n<p dir=\"auto\">Try the tasks suggested at the start of this section on the <code>blog</code> crate as it\nis after Listing 17-21 to see what you think about the design of this version\nof the code. Note that some of the tasks might be completed already in this\ndesign.</p>\n<p dir=\"auto\">We’ve seen that even though Rust is capable of implementing object-oriented\ndesign patterns, other patterns, such as encoding state into the type system,\nare also available in Rust. These patterns have different trade-offs. Although\nyou might be very familiar with object-oriented patterns, rethinking the\nproblem to take advantage of Rust’s features can provide benefits, such as\npreventing some bugs at compile time. Object-oriented patterns won’t always be\nthe best solution in Rust due to certain features, like ownership, that\nobject-oriented languages don’t have.</p>\n<h2 tabindex=\"-1\" id=\"user-content-summary\" dir=\"auto\"><a class=\"heading-link\" href=\"#summary\">Summary<svg class=\"octicon octicon-link\" viewBox=\"0 0 16 16\" version=\"1.1\" width=\"16\" height=\"16\" aria-hidden=\"true\"><path d=\"m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z\"></path></svg></a></h2>\n<p dir=\"auto\">No matter whether or not you think Rust is an object-oriented language after\nreading this chapter, you now know that you can use trait objects to get some\nobject-oriented features in Rust. Dynamic dispatch can give your code some\nflexibility in exchange for a bit of runtime performance. You can use this\nflexibility to implement object-oriented patterns that can help your code’s\nmaintainability. Rust also has other features, like ownership, that\nobject-oriented languages don’t have. An object-oriented pattern won’t always\nbe the best way to take advantage of Rust’s strengths, but is an available\noption.</p>\n<p dir=\"auto\">Next, we’ll look at patterns, which are another of Rust’s features that enable\nlots of flexibility. We’ve looked at them briefly throughout the book but\nhaven’t seen their full capability yet. Let’s go!</p>\n</article>","renderedFileInfo":null,"shortPath":null,"tabSize":8,"topBannersInfo":{"overridingGlobalFundingFile":false,"globalPreferredFundingPath":null,"repoOwner":"rust-lang","repoName":"book","showInvalidCitationWarning":false,"citationHelpUrl":"https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-repository-on-github/about-citation-files","showDependabotConfigurationBanner":false,"actionsOnboardingTip":null},"truncated":false,"viewable":true,"workflowRedirectUrl":null,"symbols":{"timedOut":false,"notAnalyzed":true,"symbols":[]}},"copilotInfo":null,"csrf_tokens":{"/rust-lang/book/branches":{"post":"HtiuETG_yGUh5d7JXnzDcG_IMVxUxdXEaxo3tR0skYmazDrAFk_6Tk2pLCjxBWrOO-M-afthUwiUPfMcjDZEdA"},"/repos/preferences":{"post":"YypWZSH4rXj1tTbaII6Idvo2aHaSwVhLFg69tN6xsRvkkA6TlniavnCwm8m7NICgmTbLoQdVnWQfstcafLl3Rg"}}},"title":"book/src/ch17-03-oo-design-patterns.md at main · rust-lang/book"}